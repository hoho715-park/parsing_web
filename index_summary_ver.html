<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JavaScript Code Parsing & Summary Web App</title>

<!-- JSZip -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- Meriyah Parser -->
<script src="https://unpkg.com/meriyah/dist/meriyah.umd.js"></script>

<style>
    body {
        background: #121212;
        color: #ffffff;
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        padding: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    h1 {
        font-size: 32px;
        margin-bottom: 20px;
        color: #FFCC66;
        text-shadow: 0 0 8px rgba(255, 204, 102, 0.5);
    }

    .upload-box {
        width: 90%;
        max-width: 600px;
        border: 2px dashed #555;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        background: #1E1E1E;
        transition: 0.3s;
        cursor: pointer;
    }

    .upload-box:hover,
    .upload-box.dragover {
        border-color: #FFCC66;
        background: #2A2A2A;
        box-shadow: 0 0 12px rgba(255, 204, 102, 0.4);
    }

    input[type="file"] { display: none; }

    #summaryBox {
        width: 90%;
        max-width: 1000px;
        background: #1E1E1E;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        line-height: 1.7;
        font-size: 16px;
    }

    /* ë ˆì´ì•„ì›ƒ: ì¢Œ/ìš° ë‘ ì¹¼ëŸ¼ */
    .quality-wrapper {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    .quality-left, .quality-right {
        flex: 1;
        padding: 20px;
        background: #1e1e1e;
        border-radius: 10px;
    }

    /* ì½”ë“œ ì˜ì—­ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .code-section {
        width: 90%;
        max-width: 1000px;
        margin-top: 20px;
    }
    .code-title {
        background: #1e1e1e;
        padding: 8px 14px;
        border-radius: 8px 8px 0 0;
        font-size: 14px;
        color: #FFCC66;
        border: 1px solid #333;
        border-bottom: none;
    }
    .code-box {
        height: 400px;
        background: #000;
        padding: 20px;
        border-radius: 0 0 10px 10px;
        border: 1px solid #333;
        overflow-y: auto;
        white-space: pre-wrap;
        font-size: 13px;
        font-family: Consolas, monospace;
        color: #00FF88;
    }

    /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ (ì½”ë“œ ë°•ìŠ¤ ë‚´ë¶€) */
    #result::-webkit-scrollbar,
    #astJsonBox::-webkit-scrollbar {
        width: 8px;
    }
    #result::-webkit-scrollbar-track,
    #astJsonBox::-webkit-scrollbar-track {
        background: #202020;
        border-radius: 10px;
    }
    #result::-webkit-scrollbar-thumb,
    #astJsonBox::-webkit-scrollbar-thumb {
        background: #00ff88cc;
        border-radius: 10px;
    }

    /* Firefoxìš© */
    #result,
    #astJsonBox {
        scrollbar-width: thin;
        scrollbar-color: #00ff88cc #202020;
    }
</style>
</head>

<body>

<h1>âš¡ JavaScript Code Parsing + AST Summary</h1>

<label for="zipUpload" id="dropZone" class="upload-box">
    <p>ğŸ“¦ ZIP íŒŒì¼ ì—…ë¡œë“œ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
    <p style="font-size: 13px; color:#aaa;">(JavaScript íŒŒì¼ í¬í•¨)</p>
    <button
        id="fileButton"
        type="button"
        style="
            margin-top:10px;
            padding:10px 20px;
            border:none;
            border-radius:8px;
            background:#FFCC66;
            color:#000;
            cursor:pointer;
            font-weight:bold;
        "
    >íŒŒì¼ ì„ íƒ</button>
</label>

<input type="file" id="zipUpload" accept=".zip">

<div id="summaryBox">ğŸ“ AST ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

<!-- ì½”ë“œ ê²°ê³¼ 1: Meriyahë¡œ íŒŒì‹±í•œ app.js AST -->
<div class="code-section">
    <div class="code-title">ğŸ“„ app.js AST (Meriyah íŒŒì‹± ê²°ê³¼)</div>
    <div id="result" class="code-box">AST ì „ì²´ JSONì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<!-- ì½”ë“œ ê²°ê³¼ 2: ZIP ë‚´ë¶€ ast.json íŒŒì¼ ë‚´ìš© -->
<div class="code-section" id="astJsonSection" style="display:none;">
    <div class="code-title">ğŸ“ ZIP ë‚´ë¶€ ast.json (ì´ë¯¸ ì¡´ì¬í•˜ëŠ” AST íŒŒì¼)</div>
    <div id="astJsonBox" class="code-box">ZIP ë‚´ë¶€ ast.json ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
</div>

<script>
let latestSummary = null;
let latestAST = null;

// ê³µí†µ DOM ì°¸ì¡°
const dropZone      = document.getElementById("dropZone");
const zipInput      = document.getElementById("zipUpload");
const fileButton    = document.getElementById("fileButton");
const summaryBox    = document.getElementById("summaryBox");
const resultBox     = document.getElementById("result");
const astJsonBox    = document.getElementById("astJsonBox");
const astJsonSection = document.getElementById("astJsonSection");

/*===============================
    íŒŒì¼ ì„ íƒ ë²„íŠ¼ â†’ input í´ë¦­
===============================*/
fileButton.addEventListener("click", (e) => {
    e.preventDefault();
    zipInput.click();
});

/*===============================
    Drag & Drop + File Input
===============================*/
dropZone.addEventListener("dragover", e => {
    e.preventDefault();
    dropZone.classList.add("dragover");
});

dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("dragover");
});

dropZone.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    const file = e.dataTransfer.files[0];
    if (file) handleZipFile(file);
});

// íŒŒì¼ ì„ íƒ input ë³€ê²½ ì‹œ
zipInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) handleZipFile(file);
});

/*===============================
    ZIP ì²˜ë¦¬
===============================*/
async function handleZipFile(file) {
    const jszip = new JSZip();
    const zip = await jszip.loadAsync(file);

    let appJsFile = null;
    let astJsonFile = null;

    zip.forEach((path, entry) => {
        if (path.endsWith("app.js")) appJsFile = entry;
        if (path.endsWith("ast.json")) astJsonFile = entry;
    });

    if (!appJsFile) {
        summaryBox.textContent = "âŒ ZIP ì•ˆì— app.js íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!";
        return;
    }

    const code = await appJsFile.async("string");

    const ast = meriyah.parse(code, { module: true, next: true, loc: true });
    latestAST = ast;

    const summary = analyzeAST(ast);
    latestSummary = summary;

    displaySummary(appJsFile.name, summary);

    resultBox.textContent = JSON.stringify(ast, null, 2);

    if (astJsonFile) {
        const text = await astJsonFile.async("string");
        astJsonSection.style.display = "block";
        astJsonBox.textContent =
            JSON.stringify(JSON.parse(text), null, 2);
    } else {
        astJsonSection.style.display = "none";
        astJsonBox.textContent = "";
    }
}

/*===============================
    AST ê¸°ë³¸ ë¶„ì„
===============================*/
function analyzeAST(ast) {
    let functions = 0, variables = 0, eventListeners = 0, lines = 0;

    function walk(node) {
        if (!node || typeof node !== "object") return;

        if (node.type === "FunctionDeclaration") functions++;
        if (node.type === "VariableDeclarator") variables++;
        if (node.type === "CallExpression" &&
            node.callee &&
            node.callee.property &&
            node.callee.property.name === "addEventListener"
        ) {
            eventListeners++;
        }

        if (node.loc) lines = Math.max(lines, node.loc.end.line);

        for (let key in node) walk(node[key]);
    }

    walk(ast);
    return { functions, variables, eventListeners, loc: lines };
}

/*===============================
    ìš°ì¸¡ í™•ì¥ ì§€í‘œ ê³„ì‚° (Lite Version)
===============================*/
function computeExtendedMetrics(ast, summary) {
    return {
        loc: summary.loc,
        cyclomatic: Math.max(1, summary.functions + summary.eventListeners),
        cbo: summary.functions,
        rfc: summary.functions + summary.variables,
        fanOut: summary.variables,
        lcom: Math.max(0, summary.functions - 1),
        tcc: 1 - (summary.functions / 50),
        dit: 1,
        noc: 0,
        wmc: summary.functions * 2,
        halsteadVolume: summary.variables * 10,
        halsteadEffort: summary.variables * 30,
        maintainabilityIndex: 171 - summary.functions - summary.variables
    };
}

/*===============================
    ìš”ì•½ ë°•ìŠ¤ UI ë Œë”ë§
===============================*/
function displaySummary(fileName, summary) {
    const qualityScore = calculateQualityScore(summary);
    const extended = computeExtendedMetrics(latestAST, summary);

    summaryBox.innerHTML = `
        <h3>ğŸ“Š AST ìš”ì•½ ë¶„ì„ ê²°ê³¼</h3>
        âœ” í•¨ìˆ˜ ì„ ì–¸: <b>${summary.functions}</b><br>
        âœ” ë³€ìˆ˜ ì„ ì–¸: <b>${summary.variables}</b><br>
        âœ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬: <b>${summary.eventListeners}</b><br>
        âœ” LOC: <b>${summary.loc}</b><br>
        âœ” íŒŒì¼ ì´ë¦„: <b>${fileName}</b><br>
        âœ” ë¶„ì„ ì‹œê°„: <b>${new Date().toLocaleTimeString()}</b><br><br>

        <div class="quality-wrapper">

            <!-- ì™¼ìª½ íŒ¨ë„ -->
            <div class="quality-left">
                <h3>ğŸ§ª ì½”ë“œ í’ˆì§ˆ ì§€í‘œ</h3>
                â€¢ í•¨ìˆ˜ ë³µì¡ë„ ì ìˆ˜: <b>${qualityScore.funcScore}</b> / 100<br>
                â€¢ ë³€ìˆ˜ ê´€ë¦¬ ì ìˆ˜: <b>${qualityScore.varScore}</b> / 100<br>
                â€¢ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì ìˆ˜: <b>${qualityScore.eventScore}</b> / 100<br>
                â€¢ ìœ ì§€ë³´ìˆ˜ ì§€ìˆ˜(MI ì¶”ì •): <b>${qualityScore.miScore}</b> / 100<br>
                <hr>
                ğŸ“˜ <b>ì´í•© ì½”ë“œ í’ˆì§ˆ ì ìˆ˜: ${qualityScore.total} ì </b>
            </div>

            <!-- ì˜¤ë¥¸ìª½ íŒ¨ë„ -->
            <div class="quality-right">
                <h3>ğŸ“ í™•ì¥ ì½”ë“œ ë©”íŠ¸ë¦­</h3>
                â€¢ LOC <span style="color:#aaa">(ì½”ë“œ ë¼ì¸ ìˆ˜)</span>: <b>${extended.loc}</b><br>
                â€¢ Cyclomatic Complexity <span style="color:#aaa">(ë¶„ê¸° ë³µì¡ë„)</span>: <b>${extended.cyclomatic}</b><br>
                â€¢ Coupling (CBO) <span style="color:#aaa">(ê²°í•©ë„)</span>: <b>${extended.cbo}</b><br>
                â€¢ RFC <span style="color:#aaa">(ì‘ë‹µ ë©”ì„œë“œ ìˆ˜)</span>: <b>${extended.rfc}</b><br>
                â€¢ Fan-out <span style="color:#aaa">(ë‹¤ë¥¸ ëª¨ë“ˆë¡œì˜ ì˜ì¡´)</span>: <b>${extended.fanOut}</b><br>
                â€¢ Cohesion (LCOM) <span style="color:#aaa">(ì‘ì§‘ë„ ë¶€ì¡±)</span>: <b>${extended.lcom}</b><br>
                â€¢ TCC <span style="color:#aaa">(ê°•í•œ í´ë˜ìŠ¤ ì‘ì§‘ë„)</span>: <b>${extended.tcc.toFixed(2)}</b><br>
                â€¢ DIT <span style="color:#aaa">(ìƒì† ê¹Šì´)</span>: <b>${extended.dit}</b><br>
                â€¢ NOC <span style="color:#aaa">(ìì‹ í´ë˜ìŠ¤ ìˆ˜)</span>: <b>${extended.noc}</b><br>
                â€¢ WMC <span style="color:#aaa">(ê°€ì¤‘ ë©”ì„œë“œ ìˆ˜)</span>: <b>${extended.wmc}</b><br>
                â€¢ Halstead Volume <span style="color:#aaa">(í• ìŠ¤í…Œë“œ ë³¼ë¥¨)</span>: <b>${extended.halsteadVolume}</b><br>
                â€¢ Halstead Effort <span style="color:#aaa">(í• ìŠ¤í…Œë“œ ë…¸ë ¥ì¹˜)</span>: <b>${extended.halsteadEffort}</b><br>
                â€¢ Maintainability Index <span style="color:#aaa">(ìœ ì§€ë³´ìˆ˜ ì§€ìˆ˜)</span>: <b>${extended.maintainabilityIndex}</b><br>
            </div>

        </div>
    `;
}

/*===============================
    í’ˆì§ˆ ì ìˆ˜ ê³„ì‚°
===============================*/
function calculateQualityScore(summary) {
    const maxFunc = 20;
    const maxVar  = 30;

    const funcScore  = Math.max(0, 100 - (summary.functions / maxFunc) * 100);
    const varScore   = Math.max(0, 100 - (summary.variables / maxVar) * 100);
    const eventScore = Math.max(0, 100 - Math.abs(summary.eventListeners - 3) * 20);

    const miScore = Math.round(
        funcScore * 0.4 +
        varScore  * 0.3 +
        eventScore * 0.3
    );

    return {
        funcScore: Math.round(funcScore),
        varScore: Math.round(varScore),
        eventScore: Math.round(eventScore),
        miScore,
        total: Math.round((funcScore + varScore + eventScore + miScore) / 4)
    };
}
</script>

</body>
</html>
